<!DOCTYPE html>
<html>
<head>
    <title>Thermostat Control</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: auto; }
        .input-group { margin: 10px 0; }
        label { display: inline-block; width: 150px; }
        input[type="number"] { padding: 5px; width: 100px; }
        button { padding: 5px 10px; margin: 5px 0; }
        #update_status { color: blue; }
        #relay_mismatch { color: red; }
    </style>
    <style>
        .error-message {
            color: red;
            font-weight: bold;
            display: none;
        }
    </style>
</head>
<body>
    <div id="errorMessage" class="error-message"></div>
    <div class="container">
        <h1>Thermostat Control</h1>
        <div class="input-group">
            <label>Temperature:</label> <span id="temperature">N/A</span> °C
        </div>
        <div class="input-group">
            <label>Setpoint:</label> <span id="setpoint">N/A</span> °C
        </div>
        <div class="input-group">
            <label>High Hysteresis:</label> <span id="high_hyst">N/A</span> °C
        </div>
        <div class="input-group">
            <label>Low Hysteresis:</label> <span id="low_hyst">N/A</span> °C
        </div>
        <div class="input-group">
            <label>Relay Actual:</label> 
            <span id="relay_actual">N/A</span>
            <label>Relay Commanded:</label> 
            <span id="relay_commanded">N/A</span>
            <span id="relay_mismatch" style="display:none;">(Mismatch)</span>
        </div>
        <div id="update_status" style="color: blue;"></div>
        <div class="input-group">
            <label>Running State:</label> <span id="running">N/A</span>
        </div>
        <div class="input-group">
            <label>New Setpoint:</label>
            <input type="number" id="new_setpoint" step="0.1" value="19.0">
            <button onclick="startUpdateSetpoint()">Update Setpoint</button>
        </div>
        <div class="input-group">
            <label>New High Hysteresis:</label>
            <input type="number" id="new_high_hyst" step="0.1" value="0.1">
            <button onclick="startUpdateHighHysteresis()">Update High Hysteresis</button>
        </div>
        <div class="input-group">
            <label>New Low Hysteresis:</label>
            <input type="number" id="new_low_hyst" step="0.1" value="0.1">
            <button onclick="startUpdateLowHysteresis()">Update Low Hysteresis</button>
        </div>

<script>
    let updateInterval = null;

    function fetchData() {
        fetch('/data', { cache: 'no-store' })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok ' + response.status);
                return response.text();
            })
            .then(text => {
                try {
                    if (text.trim() === '') {
                        return;
                    }
                    const data = JSON.parse(text);
                    document.getElementById('temperature').textContent = data.temperature !== undefined && data.temperature !== '0.0' ? data.temperature : 'N/A';
                    document.getElementById('setpoint').textContent = data.setpoint !== undefined && data.setpoint !== '0.0' ? data.setpoint : 'N/A';
                    document.getElementById('high_hyst').textContent = data.high_hyst !== undefined && data.high_hyst !== '0.0' ? data.high_hyst : 'N/A';
                    document.getElementById('low_hyst').textContent = data.low_hyst !== undefined && data.low_hyst !== '0.0' ? data.low_hyst : 'N/A';
                    document.getElementById('relay_actual').textContent = data.relay_actual || 'N/A';
                    document.getElementById('relay_commanded').textContent = data.relay_commanded || 'N/A';
                    document.getElementById('running').textContent = data.running || 'N/A';
                    document.getElementById('update_status').textContent = data.update_status || '';

                    const relayActual = document.getElementById('relay_actual').textContent;
                    const relayCommanded = document.getElementById('relay_commanded').textContent;
                    const mismatchSpan = document.getElementById('relay_mismatch');
                    if (relayActual !== 'N/A' && relayCommanded !== 'N/A' && relayActual !== relayCommanded) {
                        mismatchSpan.style.display = 'inline';
                    } else {
                        mismatchSpan.style.display = 'none';
                    }

                    if (!data.update_status && updateInterval) {
                        clearInterval(updateInterval);
                        updateInterval = null;
                    }
                } catch (e) {
                    console.error('Invalid JSON:', text, e);
                    document.getElementById('update_status').textContent = 'Error: Invalid data received in fetchData';
                }
            })
            .catch(error => console.error('Error fetching data:', error));
    }

    function startUpdate(operation, value, urlParam) {
        if (updateInterval) clearInterval(updateInterval);
        updateInterval = setInterval(fetchData, 1000);

        fetch('/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `${urlParam}=${encodeURIComponent(value)}`
        })
        .then(response => {
            if (!response.ok) throw new Error('Update failed ' + response.status);
            return response.text();
        })
        .then(text => {
            try {
                const data = JSON.parse(text);
                document.getElementById('temperature').textContent = data.temperature !== undefined && data.temperature !== '0.0' ? data.temperature : 'N/A';
                document.getElementById('setpoint').textContent = data.setpoint !== undefined && data.setpoint !== '0.0' ? data.setpoint : 'N/A';
                document.getElementById('high_hyst').textContent = data.high_hyst !== undefined && data.high_hyst !== '0.0' ? data.high_hyst : 'N/A';
                document.getElementById('low_hyst').textContent = data.low_hyst !== undefined && data.low_hyst !== '0.0' ? data.low_hyst : 'N/A';
                document.getElementById('relay_actual').textContent = data.relay_actual || 'N/A';
                document.getElementById('relay_commanded').textContent = data.relay_commanded || 'N/A';
                document.getElementById('running').textContent = data.running || 'N/A';
                document.getElementById('update_status').textContent = data.update_status || '';

                const relayActual = document.getElementById('relay_actual').textContent;
                const relayCommanded = document.getElementById('relay_commanded').textContent;
                const mismatchSpan = document.getElementById('relay_mismatch');
                if (relayActual !== 'N/A' && relayCommanded !== 'N/A' && relayActual !== relayCommanded) {
                    mismatchSpan.style.display = 'inline';
                } else {
                    mismatchSpan.style.display = 'none';
                }
            } catch (e) {
                console.error('Invalid JSON from POST:', text, e);
                document.getElementById('update_status').textContent = 'Error: Invalid data received in startUpdate';
            }
        })
        .catch(error => console.error('Error updating:', error));
    }

    function checkZigbeeStatus() {
        fetch('/status', { cache: 'no-store' })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok ' + response.status);
                return response.text();
            })
            .then(data => {
                if (data.trim() === '') {
                        return;
                    }
                console.log('Raw response:', data); // Ajout pour débogage
                if (data.includes("5/5 pas encore aboutie") || data.includes("ZDO Device Unavailable")) {
                    document.getElementById('errorMessage').style.display = 'block';
                    document.getElementById('errorMessage').textContent = 'Erreur : dernière commande échouée après 5 tentatives ou problème Zigbee détecté !';
                } else {
                    if(data.includes("1/5 pas encore aboutie")) {
                        document.getElementById('errorMessage').style.display = 'none';
                    }
                }
            });
    }

    function startUpdateSetpoint() {
        const setpoint = document.getElementById('new_setpoint').value;
        startUpdate('setpoint', setpoint, 'setpoint');
    }

    function startUpdateHighHysteresis() {
        const high_hyst = document.getElementById('new_high_hyst').value;
        startUpdate('high_hyst', high_hyst, 'high_hyst');
    }

    function startUpdateLowHysteresis() {
        const low_hyst = document.getElementById('new_low_hyst').value;
        startUpdate('low_hyst', low_hyst, 'low_hyst');
    }

    fetchData();
    setInterval(fetchData, 1000);
    checkZigbeeStatus();
    setInterval(checkZigbeeStatus, 5000);
</script>
    </div>
</body>
</html>