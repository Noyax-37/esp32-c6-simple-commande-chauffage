<!DOCTYPE html>
<html>
<head>
    <title>Thermostat Control</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: auto; }
        .input-group { margin: 10px 0; }
        label { display: inline-block; width: 150px; }
        input[type="number"] { padding: 5px; width: 100px; }
        button { padding: 5px 10px; margin: 5px 0; }
        #update_status { color: blue; }
        #relay_mismatch { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Thermostat Control</h1>
        <div class="input-group">
            <label>Temperature:</label> <span id="temperature">%.1f</span> °C
        </div>
        <div class="input-group">
            <label>Setpoint:</label> <span id="setpoint">%.1f</span> °C
        </div>
        <div class="input-group">
            <label>High Hysteresis:</label> <span id="high_hyst">%.1f</span> °C
        </div>
        <div class="input-group">
            <label>Low Hysteresis:</label> <span id="low_hyst">%.1f</span> °C
        </div>
        <div class="input-group">
            <label>Relay Actual:</label> 
            <span id="relay_actual">%.s</span>
            <label>Relay Commanded:</label> 
            <span id="relay_commanded">%.s</span>
            <span id="relay_mismatch" style="display:none;">(Mismatch)</span>
        </div>
        <div id="update_status" style="color: blue;"></div>
        <div class="input-group">
            <label>Running State:</label> <span id="running">%.s</span>
        </div>
        <div class="input-group">
            <label>New Setpoint:</label>
            <input type="number" id="new_setpoint" step="0.1" value="19.0">
            <button onclick="startUpdateSetpoint()">Update Setpoint</button>
        </div>
        <div class="input-group">
            <label>New High Hysteresis:</label>
            <input type="number" id="new_high_hyst" step="0.1" value="0.1">
            <button onclick="startUpdateHighHysteresis()">Update High Hysteresis</button>
        </div>
        <div class="input-group">
            <label>New Low Hysteresis:</label>
            <input type="number" id="new_low_hyst" step="0.1" value="0.1">
            <button onclick="startUpdateLowHysteresis()">Update Low Hysteresis</button>
        </div>

        <script>
            let updateInterval = null;

            function fetchData() {
                fetch('/data', { cache: 'no-store' }) // Forcer un rafraîchissement sans cache
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('temperature').textContent = data.temperature;
                        document.getElementById('setpoint').textContent = data.setpoint;
                        document.getElementById('high_hyst').textContent = data.high_hyst || 'N/A';
                        document.getElementById('low_hyst').textContent = data.low_hyst || 'N/A';
                        document.getElementById('relay_actual').textContent = data.relay_actual;
                        document.getElementById('relay_commanded').textContent = data.relay_commanded;
                        document.getElementById('running').textContent = data.running;
                        document.getElementById('update_status').textContent = data.update_status || '';

                        // Vérifier le mismatch et afficher en rouge si nécessaire
                        const relayActual = document.getElementById('relay_actual');
                        const relayCommanded = document.getElementById('relay_commanded');
                        const mismatchSpan = document.getElementById('relay_mismatch');
                        if (data.relay_actual !== "N/A" && data.relay_commanded !== "N/A" && 
                            data.relay_actual !== data.relay_commanded) {
                            mismatchSpan.style.display = "inline";
                        } else {
                            mismatchSpan.style.display = "none";
                        }

                        // Si update_status est vide et un intervalle est actif, le stopper
                        if (!data.update_status && updateInterval) {
                            clearInterval(updateInterval);
                            updateInterval = null;
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }

            function startUpdate(operation, value, urlParam) {
                if (updateInterval) clearInterval(updateInterval); // Arrêter tout intervalle précédent
                updateInterval = setInterval(fetchData, 1000); // Rafraîchir toutes les secondes

                fetch('/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `${urlParam}=${encodeURIComponent(value)}`
                })
                .then(response => response.text())
                .then(data => {
                    console.log(data);
                    fetchData(); // Forcer un rafraîchissement immédiat après la requête
                })
                .catch(error => console.error('Error:', error));
            }

            function startUpdateSetpoint() {
                const setpoint = document.getElementById('new_setpoint').value;
                startUpdate('setpoint', setpoint, 'setpoint');
            }

            function startUpdateHighHysteresis() {
                const high_hyst = document.getElementById('new_high_hyst').value;
                startUpdate('high_hyst', high_hyst, 'high_hyst');
            }

            function startUpdateLowHysteresis() {
                const low_hyst = document.getElementById('new_low_hyst').value;
                startUpdate('low_hyst', low_hyst, 'low_hyst');
            }

            // Rafraîchir les données toutes les secondes
            setInterval(fetchData, 1000);
            fetchData(); // Chargement initial
        </script>
    </div>
</body>
</html>